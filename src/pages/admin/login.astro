---
import "../../styles/global.css";
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>Admin Login | KowTattys</title>
        <meta name="robots" content="noindex, nofollow" />
    </head>
    <body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">
        <!-- Check if already logged in -->
        <script>
            import { supabase } from "../../lib/supabase";

            async function checkExistingSession() {
                const {
                    data: { session },
                } = await supabase.auth.getSession();

                if (session) {
                    // Sync cookies for SSR support
                    const { access_token, refresh_token } = session;
                    const expiration = 60 * 60 * 24 * 7; // 7 days
                    document.cookie = `sb-access-token=${access_token}; path=/; max-age=${expiration}; SameSite=Lax; secure`;
                    document.cookie = `sb-refresh-token=${refresh_token}; path=/; max-age=${expiration}; SameSite=Lax; secure`;

                    window.location.href = "/admin";
                }
            }

            checkExistingSession();
        </script>

        <div class="w-full max-w-md">
            <!-- Logo -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white font-doto">
                    KowTattys
                </h1>
                <p class="text-gray-400 mt-2">Admin Portal</p>
            </div>

            <!-- Login Card -->
            <div class="bg-gray-800 rounded-xl shadow-2xl p-8">
                <h2 class="text-2xl font-bold text-white mb-6">Sign In</h2>

                <!-- Error Message -->
                <div
                    id="error-message"
                    class="hidden mb-4 p-4 bg-red-500/10 border border-red-500/50 rounded-lg text-red-400 text-sm"
                >
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-300 mb-2"
                        >
                            Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="admin@kowtattys.com"
                        />
                    </div>

                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-gray-300 mb-2"
                        >
                            Password
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="btn-text">Sign In</span>
                        <span id="btn-loading" class="hidden">
                            <svg
                                class="animate-spin h-5 w-5 mx-auto"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                        </span>
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a
                        href="/"
                        class="text-sm text-gray-400 hover:text-white transition-colors"
                    >
                        ← Back to Website
                    </a>
                </div>
            </div>

            <!-- Security Notice -->
            <p class="text-center text-gray-500 text-xs mt-6">
                This is a secure admin area. Unauthorized access is prohibited.
            </p>
        </div>

        <script>
            import { supabase } from "../../lib/supabase";

            const form = document.getElementById(
                "login-form",
            ) as HTMLFormElement;
            const errorMessage = document.getElementById("error-message");
            const submitBtn = document.getElementById(
                "submit-btn",
            ) as HTMLButtonElement;
            const btnText = document.getElementById("btn-text");
            const btnLoading = document.getElementById("btn-loading");

            function showError(message: string) {
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove("hidden");
                }
            }

            function hideError() {
                if (errorMessage) {
                    errorMessage.classList.add("hidden");
                }
            }

            function setLoading(loading: boolean) {
                if (submitBtn && btnText && btnLoading) {
                    submitBtn.disabled = loading;
                    btnText.classList.toggle("hidden", loading);
                    btnLoading.classList.toggle("hidden", !loading);
                }
            }

            form?.addEventListener("submit", async (e) => {
                e.preventDefault();
                hideError();
                setLoading(true);

                const formData = new FormData(form);
                const email = formData.get("email") as string;
                const password = formData.get("password") as string;

                try {
                    const { data, error } =
                        await supabase.auth.signInWithPassword({
                            email,
                            password,
                        });

                    if (error) {
                        showError(error.message);
                        setLoading(false);
                        return;
                    }

                    if (data.session) {
                        // Set session cookies for SSR support
                        const { access_token, refresh_token } = data.session;
                        const expiration = 60 * 60 * 24 * 7; // 7 days
                        document.cookie = `sb-access-token=${access_token}; path=/; max-age=${expiration}; SameSite=Lax; secure`;
                        document.cookie = `sb-refresh-token=${refresh_token}; path=/; max-age=${expiration}; SameSite=Lax; secure`;

                        window.location.href = "/admin";
                    }
                } catch (err) {
                    showError(
                        "An unexpected error occurred. Please try again.",
                    );
                    setLoading(false);
                }
            });
        </script>

        <style>
            @import url("https://fonts.googleapis.com/css2?family=Doto:wght@100..900&display=swap");

            .font-doto {
                font-family: "Doto", sans-serif;
            }
        </style>
    </body>
</html>
